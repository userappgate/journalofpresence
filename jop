#!/usr/bin/python3
import datetime
import subprocess

template='''
===========================================================
|                                                         |
|                    JOURNAL OF PRESENCE                  |
|                                                         |
===========================================================

| Company      | Year   | Period           |
--------------------------------------------
|              |        |                  |
| Cryptzone AB | {year:>4}   | 16-{pmonth:<3} to 15-{cmonth:<3} |
|              |        |                  |
--------------------------------------------
| Name                                     |
--------------------------------------------
|                                          |
| {name:<41}|
|                                          |
--------------------------------------------
| All presence | No of empl |
-----------------------------
|              |            |
|      {all_presence:<1}       |  {employee_number:<4}      |
|              |            |
-----------------------------

===========================================================
|                                                         |
|                   JOURNAL OF ABSENCE                    |
|                                                         |
===========================================================

 Date                       Days        Reason
-----------------------------------------------------------
{absences}

-----------------------------------------------------------
Reasons of absence          |  Signature of Employee      |
-----------------------------------------------------------
A: Vacation                 |                             |
B: Sickness                 |                             |
C: Caring of a sick child   |                             |
D: Absence without pay      |                             |
E: Other reason             |                             |
----------------------------|------------------------------
                        | Signature of management leader  |
                        |                                 |
                        |                                 |
                        |                                 |
                        |                                 |
                        |---------------------------------|
'''

months=['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']


absences = ''

print('''
A: Vacation
B: Sickness
C: Caring of a sick child
D: Absence without pay
E: Other reason
''')

while True:
    from_ = input('From (dd/mm): ')
    if not from_:
        break
    to = input('To (dd/mm): ')
    reason = input('Reason: ').upper()

    fday, fmonth = [int(i) for i in from_.split('/')]
    tday, tmonth = [int(i) for i in to.split('/')]
    month = datetime.datetime.now().month
    year = datetime.datetime.now().year
    fyear = year - 1 if fmonth == 12 and month == 1 else year
    tyear = year - 1 if tmonth == 12 and month == 1 else year

    date_from = datetime.date(fyear, fmonth, fday)
    date_to = datetime.date(tyear, tmonth, tday)

    days = (date_to - date_from).days + 1

    absences += f'{fyear}/{fmonth:02}/{fday:02} to {tyear}/{tmonth:02}/{tday:02}    {days:<8}    {reason}\n'

name = input('Full name: ')

jop = template.format(
    year=datetime.datetime.now().year,
    cmonth=months[datetime.datetime.now().month - 1],
    pmonth=months[datetime.datetime.now().month - 2],
    employee_number='??',
    all_presence = ' ' if absences else '✔',
    name=name,
    absences=absences,
)

jopfile = 'jop-' + str(datetime.datetime.now().date()) + '.txt'
with open(jopfile, 'wt') as f:
    f.write(jop)
print(jop)

print('Signing journal of presence file…')
subprocess.check_call(['gpg', '--armour', '--sign', jopfile])

toprint = input('Do you want to print it? (y/N)')

if toprint.lower().startswith('y'):
    subprocess.check_call(['lpr', jopfile])
